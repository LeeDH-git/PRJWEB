<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
	MyBatis는 기본적으로 PreparedStatement를 이용해서 처리됨.
	개발자가 PreparedStatement에 들어가는 파라미터를 사용할 때는 '#{}'기호를 이용해서 처리함.
	'#{}'의 규칙.
	1. 파라미터가 여러 속성을 가진 객체인 경우, '#{num}'은 getNum() or setNum()을 의미함.
	2. 파라미터가 하나이고, 기본자료형이나 문자열인 경우 값이 그대로 전달됨.
	3. 파라미터가 Map타입인 경우 '#{num}'은 Map객체의 키값이 'num'인 값을 찾는다.

	패키지익스플로러에서 프로젝트 경로구조와 상관없이 개발자가 mapper태그의 namespace 속성값을
    지정한 것이 프로젝트에서 통용되는 경로명으로 인식됨. -->

<mapper namespace="org.leedh.mapper.BoardMapper">

    <sql id="criteria">
        <trim prefix="(" suffix=") AND " prefixOverrides="OR">
            <foreach item='type' collection="typeArr">
                <trim prefix="OR">
                    <choose>
                        <when test="type == 'T'.toString()">
                            TITLE LIKE '%'||#{keyword}||'%'
                        </when>
                        <when test="type == 'C'.toString()">
                            CONTENT LIKE '%'||#{keyword}||'%'
                        </when>
                        <when test="type == 'W'.toString()">
                            WRITER LIKE '%'||#{keyword}||'%'
                        </when>
                    </choose>
                </trim>
            </foreach>
        </trim>
    </sql>


    <select id="getList" resultType="boardVO">
	<![CDATA[
        SELECT
            *
        FROM
            TBL_BOARD
        WHERE
            BNO > 0
        ]]>
	</select>

    <insert id="insert">
		INSERT INTO
		    TBL_BOARD (BNO,TITLE,CONTENT,WRITER)
		VALUES
		    (SEQ_BOARD.NEXTVAL, #{title}, #{content}, #{writer})
	</insert>

    <insert id="insertSelectKey">

        <selectKey keyProperty="bno" order="BEFORE"
                   resultType="long">
            SELECT
                SEQ_BOARD.NEXTVAL
            FROM
                DUAL
        </selectKey>

        INSERT INTO
            TBL_BOARD (BNO,TITLE,CONTENT, WRITER)
        VALUES
            (#{bno},#{title}, #{content}, #{writer})
    </insert>

    <select id="read" resultType="boardVO">
		SELECT
		    *
		FROM
		    TBL_BOARD
		WHERE
		    BNO = #{bno}
	</select>


    <delete id="delete">
		DELETE
		    TBL_BOARD
		WHERE
		    BNO = #{bno}
	</delete>

    <update id="update">
		UPDATE
		    TBL_BOARD
		SET
            TITLE= #{title},
            CONTENT=#{content},
            WRITER = #{writer},
            UPDATEDATE = sysdate
		WHERE
		    BNO = #{bno}
	</update>

    <select id="getListWithPaging" resultType="boardVO">
        <![CDATA[
             SELECT
                *
             FROM
                (
                    SELECT
                        /*+INDEX_DESC(TBL_BOARD PK_BOARD) */
                        ROWNUM RN, BNO, TITLE, CONTENT, WRITER, REGDATE, UPDATEDATE, REPLYCNT
                    FROM
                        TBL_BOARD
                    WHERE
        ]]>

       <include refid="criteria"></include>

        <![CDATA[
            ROWNUM <= #{pageNum} * #{amount} )
            WHERE
                RN > (#{pageNum} -1) * #{amount}
        ]]>
    </select>


    <select id="getTotalCount" resultType="int">
        SELECT
            COUNT(*)
        FROM
            TBL_BOARD
        WHERE
            <include refid="criteria"></include>
            BNO > 0
    </select>

    <update id="updateReplyCnt">
        UPDATE
            TBL_BOARD
        SET
            REPLYCNT = REPLYCNT + #{amount}
        WHERE
              BNO = #{bno}
    </update>


</mapper>
